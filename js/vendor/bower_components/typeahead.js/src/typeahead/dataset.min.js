var Dataset=(function(){var l,o;l={val:"tt-selectable-display",obj:"tt-selectable-object"};o=_.getIdGenerator();function w(y,x){y=y||{};y.templates=y.templates||{};y.templates.notFound=y.templates.notFound||y.templates.empty;if(!y.source){$.error("missing source")}if(!y.node){$.error("missing node")}if(y.name&&!d(y.name)){$.error("invalid dataset name: "+y.name)}x.mixin(this);this.highlight=!!y.highlight;this.name=y.name||o();this.limit=y.limit||5;this.displayFn=n(y.display||y.displayKey);this.templates=e(y.templates,this.displayFn);this.source=y.source.__ttAdapter?y.source.__ttAdapter():y.source;this.async=_.isUndefined(y.async)?this.source.length>2:!!y.async;this._resetLastSuggestion();this.$el=$(y.node).addClass(this.classes.dataset).addClass(this.classes.dataset+"-"+this.name)}w.extractData=function u(y){var x=$(y);if(x.data(l.obj)){return{val:x.data(l.val)||"",obj:x.data(l.obj)||null}}return null};_.mixin(w.prototype,EventEmitter,{_overwrite:function b(y,x){x=x||[];if(x.length){this._renderSuggestions(y,x)}else{if(this.async&&this.templates.pending){this._renderPending(y)}else{if(!this.async&&this.templates.notFound){this._renderNotFound(y)}else{this._empty()}}}this.trigger("rendered",this.name,x,false)},_append:function s(y,x){x=x||[];if(x.length&&this.$lastSuggestion.length){this._appendSuggestions(y,x)}else{if(x.length){this._renderSuggestions(y,x)}else{if(!this.$lastSuggestion.length&&this.templates.notFound){this._renderNotFound(y)}}}this.trigger("rendered",this.name,x,true)},_renderSuggestions:function m(y,x){var z;z=this._getSuggestionsFragment(y,x);this.$lastSuggestion=z.children().last();this.$el.html(z).prepend(this._getHeader(y,x)).append(this._getFooter(y,x))},_appendSuggestions:function c(y,x){var A,z;A=this._getSuggestionsFragment(y,x);z=A.children().last();this.$lastSuggestion.after(A);this.$lastSuggestion=z},_renderPending:function g(y){var x=this.templates.pending;this._resetLastSuggestion();x&&this.$el.html(x({query:y,dataset:this.name}))},_renderNotFound:function r(y){var x=this.templates.notFound;this._resetLastSuggestion();x&&this.$el.html(x({query:y,dataset:this.name}))},_empty:function h(){this.$el.empty();this._resetLastSuggestion()},_getSuggestionsFragment:function a(B,x){var z=this,y;y=document.createDocumentFragment();_.each(x,function A(C){var E,D;D=z._injectQuery(B,C);E=$(z.templates.suggestion(D)).data(l.obj,C).data(l.val,z.displayFn(C)).addClass(z.classes.suggestion+" "+z.classes.selectable);y.appendChild(E[0])});this.highlight&&highlight({className:this.classes.highlight,node:y,pattern:B});return $(y)},_getFooter:function j(y,x){return this.templates.footer?this.templates.footer({query:y,suggestions:x,dataset:this.name}):null},_getHeader:function q(y,x){return this.templates.header?this.templates.header({query:y,suggestions:x,dataset:this.name}):null},_resetLastSuggestion:function i(){this.$lastSuggestion=$()},_injectQuery:function v(x,y){return _.isObject(y)?_.mixin({_query:x},y):y},update:function f(D){var C=this,y=false,x=false,E=0;this.cancel();this.cancel=function B(){y=true;C.cancel=$.noop;C.async&&C.trigger("asyncCanceled",D)};this.source(D,A,z);!x&&A([]);function A(F){if(x){return}x=true;F=(F||[]).slice(0,C.limit);E=F.length;C._overwrite(D,F);if(E<C.limit&&C.async){C.trigger("asyncRequested",D)}}function z(F){F=F||[];if(!y&&E<C.limit){C.cancel=$.noop;E+=F.length;C._append(D,F.slice(0,C.limit-E));C.async&&C.trigger("asyncReceived",D)}}},cancel:$.noop,clear:function p(){this._empty();this.cancel();this.trigger("cleared")},isEmpty:function k(){return this.$el.is(":empty")},destroy:function t(){this.$el=$("<div>")}});return w;function n(x){x=x||_.stringify;return _.isFunction(x)?x:y;function y(z){return z[x]}}function e(y,z){return{notFound:y.notFound&&_.templatify(y.notFound),pending:y.pending&&_.templatify(y.pending),header:y.header&&_.templatify(y.header),footer:y.footer&&_.templatify(y.footer),suggestion:y.suggestion||x};function x(A){return $("<div>").text(z(A))}}function d(x){return(/^[_a-zA-Z0-9-]+$/).test(x)}})();