var Typeahead=(function(){function s(c,O){var W,R,Q,T,S,V,Y,U,Z,X,P;c=c||{};if(!c.input){$.error("missing input")}if(!c.menu){$.error("missing menu")}if(!c.eventBus){$.error("missing event bus")}O.mixin(this);this.eventBus=c.eventBus;this.minLength=_.isNumber(c.minLength)?c.minLength:1;this.input=c.input;this.menu=c.menu;this.enabled=true;this.active=false;this.input.hasFocus()&&this.activate();this.dir=this.input.getLangDir();this._hacks();this.menu.bind().onSync("selectableClicked",this._onSelectableClicked,this).onSync("asyncRequested",this._onAsyncRequested,this).onSync("asyncCanceled",this._onAsyncCanceled,this).onSync("asyncReceived",this._onAsyncReceived,this).onSync("datasetRendered",this._onDatasetRendered,this).onSync("datasetCleared",this._onDatasetCleared,this);W=J(this,"activate","open","_onFocused");R=J(this,"deactivate","_onBlurred");Q=J(this,"isActive","isOpen","_onEnterKeyed");T=J(this,"isActive","isOpen","_onTabKeyed");S=J(this,"isActive","_onEscKeyed");V=J(this,"isActive","open","_onUpKeyed");Y=J(this,"isActive","open","_onDownKeyed");U=J(this,"isActive","isOpen","_onLeftKeyed");Z=J(this,"isActive","isOpen","_onRightKeyed");X=J(this,"_openIfActive","_onQueryChanged");P=J(this,"_openIfActive","_onWhitespaceChanged");this.input.bind().onSync("focused",W,this).onSync("blurred",R,this).onSync("enterKeyed",Q,this).onSync("tabKeyed",T,this).onSync("escKeyed",S,this).onSync("upKeyed",V,this).onSync("downKeyed",Y,this).onSync("leftKeyed",U,this).onSync("rightKeyed",Z,this).onSync("queryChanged",X,this).onSync("whitespaceChanged",P,this).onSync("langDirChanged",this._onLangDirChanged,this)}_.mixin(s.prototype,{_hacks:function A(){var O,c;O=this.input.$input||$("<div>");c=this.menu.$node||$("<div>");O.on("blur.tt",function(Q){var S,R,P;S=document.activeElement;R=c.is(S);P=c.has(S).length>0;if(_.isMsie()&&(R||P)){Q.preventDefault();Q.stopImmediatePropagation();_.defer(function(){O.focus()})}});c.on("mousedown.tt",function(P){P.preventDefault()})},_onSelectableClicked:function p(O,c){this.select(c)},_onDatasetCleared:function l(){this._updateHint()},_onDatasetRendered:function b(P,Q,c,O){this._updateHint();this.eventBus.trigger("render",c,O,Q)},_onAsyncRequested:function r(c,P,O){this.eventBus.trigger("asyncrequest",O,P)},_onAsyncCanceled:function w(c,P,O){this.eventBus.trigger("asynccancel",O,P)},_onAsyncReceived:function e(c,P,O){this.eventBus.trigger("asyncreceive",O,P)},_onFocused:function L(){this._minLengthMet()&&this.menu.update(this.input.getQuery())},_onBlurred:function o(){if(this.input.hasQueryChangedSinceLastFocus()){this.eventBus.trigger("change",this.input.getQuery())}},_onEnterKeyed:function h(P,O){var c;if(c=this.menu.getActiveSelectable()){this.select(c)&&O.preventDefault()}},_onTabKeyed:function k(P,O){var c;if(c=this.menu.getActiveSelectable()){this.select(c)&&O.preventDefault()}else{if(c=this.menu.getTopSelectable()){this.autocomplete(c)&&O.preventDefault()}}},_onEscKeyed:function x(){this.close()},_onUpKeyed:function F(){this.moveCursor(-1)},_onDownKeyed:function K(){this.moveCursor(+1)},_onLeftKeyed:function y(){if(this.dir==="rtl"&&this.input.isCursorAtEnd()){this.autocomplete(this.menu.getTopSelectable())}},_onRightKeyed:function z(){if(this.dir==="ltr"&&this.input.isCursorAtEnd()){this.autocomplete(this.menu.getTopSelectable())}},_onQueryChanged:function n(O,c){this._minLengthMet(c)?this.menu.update(c):this.menu.empty()},_onWhitespaceChanged:function N(){this._updateHint()},_onLangDirChanged:function I(O,c){if(this.dir!==c){this.dir=c;this.menu.setLanguageDirection(c)}},_openIfActive:function H(){this.isActive()&&this.open()},_minLengthMet:function M(c){c=_.isString(c)?c:(this.input.getQuery()||"");return c.length>=this.minLength},_updateHint:function u(){var O,S,T,R,Q,c,P;O=this.menu.getTopSelectable();S=this.menu.getSelectableData(O);T=this.input.getInputValue();if(S&&!_.isBlankString(T)&&!this.input.hasOverflow()){R=Input.normalizeQuery(T);Q=_.escapeRegExChars(R);c=new RegExp("^(?:"+Q+")(.+$)","i");P=c.exec(S.val);P&&this.input.setHint(T+P[1])}else{this.input.clearHint()}},isEnabled:function E(){return this.enabled},enable:function j(){this.enabled=true},disable:function i(){this.enabled=false},isActive:function G(){return this.active},activate:function m(){if(this.isActive()){return true}else{if(!this.isEnabled()||this.eventBus.before("active")){return false}else{this.active=true;this.eventBus.trigger("active");return true}}},deactivate:function f(){if(!this.isActive()){return true}else{if(this.eventBus.before("idle")){return false}else{this.active=false;this.close();this.eventBus.trigger("idle");return true}}},isOpen:function d(){return this.menu.isOpen()},open:function t(){if(!this.isOpen()&&!this.eventBus.before("open")){this.menu.open();this._updateHint();this.eventBus.trigger("open")}return this.isOpen()},close:function B(){if(this.isOpen()&&!this.eventBus.before("close")){this.menu.close();this.input.clearHint();this.input.resetInputValue();this.eventBus.trigger("close")}return !this.isOpen()},setVal:function v(c){this.input.setQuery(_.toStr(c))},getVal:function q(){return this.input.getQuery()},select:function D(c){var O=this.menu.getSelectableData(c);if(O&&!this.eventBus.before("select",O.obj)){this.input.setQuery(O.val,true);this.eventBus.trigger("select",O.obj);this.close();return true}return false},autocomplete:function g(c){var P,O,Q;P=this.input.getQuery();O=this.menu.getSelectableData(c);Q=O&&P!==O.val;if(Q&&!this.eventBus.before("autocomplete",O.obj)){this.input.setQuery(O.val);this.eventBus.trigger("autocomplete",O.obj);return true}return false},moveCursor:function a(S){var Q,c,P,R,O;Q=this.input.getQuery();c=this.menu.selectableRelativeToCursor(S);P=this.menu.getSelectableData(c);R=P?P.obj:null;O=this._minLengthMet()&&this.menu.update(Q);if(!O&&!this.eventBus.before("cursorchange",R)){this.menu.setCursor(c);if(P){this.input.setInputValue(P.val)}else{this.input.resetInputValue();this._updateHint()}this.eventBus.trigger("cursorchange",R);return true}return false},destroy:function C(){this.input.destroy();this.menu.destroy()}});return s;function J(c){var O=[].slice.call(arguments,1);return function(){var P=[].slice.call(arguments);_.each(O,function(Q){return c[Q].apply(c,P)})}}})();